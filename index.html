<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link rel="stylesheet" href="maxcdn.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css" />
    <link rel="stylesheet" href="leafletManual.css"/>

    <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
          integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
            integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
            crossorigin=""></script>
    <link rel="stylesheet" href="mapStyle.css">
</head>
<body style="height: 100%;">

<script src="./jquery-3.2.1.min.js"></script>
<script src="./leaflet-src.js"></script>
<script src="./leaflet.js"></script>

<script src="js/leaflet.extra-markers.min.js"></script>

<script src="./leaflet-sidebar/src/L.Control.Sidebar.js"></script>
<link rel="stylesheet" href="./leaflet-sidebar/src/L.Control.Sidebar.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/esri-leaflet@2.0.8"></script>

<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.4/dist/esri-leaflet-geocoder.css">
<script src="https://unpkg.com/esri-leaflet-geocoder@2.2.4"></script>

<div id="mapPage">

<div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="#">Electric Line</a>
    <a href="#">Fallen Tree</a>
    <a href="#">Point</a>
</div>

<div id="headerImage" style="z-index: 1000; background-color: white; width: 100%;" class="headcontainer" >
    <button id = "locate" class="button button4" onclick="locate()">Locate Me</button>
    <button id = "openNav" class="button button6" onclick="labelArea()">Label Area</button>
    <button id = "trace" class="button button7" onclick="viewArea()">Edit View</button>
</div>

<div id='map' class="leaflet-container"></div>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.9/dist/leaflet.draw.css" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="https://cdn.rawgit.com/mejackreed/Leaflet-IIIF/v1.0.1/leaflet-iiif.js"></script>
<script src="https://unpkg.com/leaflet-draw@0.4.9/dist/leaflet.draw.js"></script>

<script>
    //Creates the basemap
    let map = L.map('map').setView([42.877742, -97.380979], 4);
    //Portland 43.6515, -70.2553
    // Additional maps

    let Satellite =  L.tileLayer(
        'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy;<a href="http://www.esri.com/">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 18,
        }).addTo(map);
    let Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
    });

    Esri_WorldTopoMap.addTo(map);

//    let Basemaps ={
//        'Satelite':Satellite,
//        'Static Map': Esri_WorldTopoMap,
//
//    };
//    let baseMaps = L.control.layers(Basemaps,null);
//    baseMaps.addTo(map);

    // User Location Tool


    let currentPosition, currLatlngObject;
    let currentLatlng = [];

    function onLocationFound(e) {

        if (currentPosition) {
            map.removeLayer(currentPosition);
        }
//        let redMarker = L.ExtraMarkers.icon({
//            icon: 'fa-coffee',
//            markerColor: 'red',
//            shape: 'square',
//        });
//        icon: redMarker,

        currentPosition = L.marker(e.latlng,{title: "Location", draggable: false, color: "red"}).addTo(map);

        currLatlngObject = currentPosition._latlng;

        currentLatlng.push(currLatlngObject.lat);
        currentLatlng.push(currLatlngObject.lng);

        currentPosition.bindPopup("You are Here!").openPopup(console.log("Located"));
        map.setView([currentPosition._latlng.lat,currentPosition._latlng.lng],12);

    }

    function onLocationError(e) {
        console.log("location lost");
        console.log(e);
    }
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    function locate() {
        map.locate({ maxZoom: 16});

    }

    let results = L.layerGroup().addTo(map);
    //GeoSearch plugin
    let searchControl = L.esri.Geocoding.geosearch().addTo(map);
    //Search Control
    searchControl.on('results', function(data){
        //Clears the results LayerGroup from the map
        results.clearLayers();

        for (let i = data.results.length - 1; i >= 0; i--) {
            //Displaying the searched and found location on the map
            let geoLocation = L.marker(data.results[i].latlng);

            results.addLayer(geoLocation);
        }

    });



    //Drawing Features being created


    var floodItems = new L.FeatureGroup();
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var floodControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#2373dc',
                    weight: 10
                }
            },
            polygon: {
                allowIntersection: false, // Restricts shapes to simple polygons
                drawError: {
                    color: '#2373dc', // Color the shape will turn when intersects
                    message: 'you can\'t draw that!' // Message that will show when intersect
                },
                shapeOptions: {
                    color: '#2373dc'
                }
            },
            circle: false, // Turns off this drawing tool
            rectangle: {
                shapeOptions: {
                    clickable: false
                }
            },
            edit: {
                featureGroup: floodItems, //REQUIRED!!
                remove: false
            }

        }

    });

    var fireItems = new L.FeatureGroup();
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var fireControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#ea1c18',
                    weight: 10
                }
            },
            polygon: {
                allowIntersection: false,
                drawError: {
                    color: '#ea1c18',
                    message: 'you can\'t draw that!'
                },
                shapeOptions: {
                    color: '#ea1c18'
                }
            },
            circle: false, // Turns off this drawing tool
            rectangle: {
                shapeOptions: {
                    clickable: false
                }
            },
            edit: {
                featureGroup: fireItems, //REQUIRED!!
                remove: false
            }

        }

    });

    var snowItems = new L.FeatureGroup();
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var snowControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#dcdcdc',
                    weight: 10
                }
            },
            polygon: {
                allowIntersection: false,
                drawError:{
                    color: '#dcdcdc',
                    message: 'no!'
                },
                shapeOptions: {
                    color: '#dcdcdc'
                }
            },
            circle: false,
            rectangle: {
                shapeOptions: {
                    clickable: false
                }
        },
        edit: {
            featureGroup: snowItems, //REQUIRED!!
            remove: false
        }

        }
    });

    var electricalItems = new L.FeatureGroup();
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var electricalControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#dcc511',
                    weight: 10
                }
            },
            polygon: {
                allowIntersection: false,
                drawError: {
                    color: '#dcc511',
                    message: 'NOPE!'
                },
                shapeOptions: {
                    color: '#dcc511'
                }
            },
            circle: false, // Turns off this drawing tool
            rectangle: {
                shapeOptions: {
                    clickable: false
                }
            },
            edit: {
                featureGroup: electricalItems, //REQUIRED!!
                remove: false
            }

        }
    });



    map.on(L.Draw.Event.CREATED, function (e) {

        let type = e.layerType;
        let layer = e.layer;
        // Do whatever else you need to. (save to db, add to map etc)

        floodItems.addLayer(layer);
        fireItems.addLayer(layer);
        snowItems.addLayer(layer);
        electricalItems.addLayer(layer);

        console.log('floodPolygon')
    });

    
    let labelCount = 1;
    function labelArea() {
        if (labelCount===1) {
            // Initialise the FeatureGroup to store editable layers
            map.addLayer(floodItems);
            map.addControl(floodControl);
            labelCount++;
        }
        else {
            map.removeControl(floodControl);
            map.removeControl(floodItems);
            labelCount--;
        }
    }

    

//Creating markers and popup displays
    let allMarkers = L.layerGroup([]);
    let users = L.layerGroup([]);
    let shelters = L.layerGroup([]);
    let floodArea = L.layerGroup([]);
    let fireArea = L.layerGroup([]);

    let newmarker = L.marker([44.808147, -68.795013]).addTo(allMarkers).addTo(users);
    newmarker.bindPopup(
        'User: Bob'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));
    let newmarker1 = L.marker([44.808147, -68.785013]).addTo(allMarkers).addTo(users);
    newmarker1.bindPopup(
        'User: Fred'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));

    let newmarker2 = L.circle([44.818147, -68.775013],
        {radius: 2000,
            color:"#09f40c"}).addTo(allMarkers).addTo(shelters);
    newmarker2.bindPopup(
        'Shelter'+'</br>'
    ).openPopup(console.log("Safe Area"));
    let flooding = L.circle([45.918147, -68.875013],
        {radius: 28000,
            color:"#0d00f4"}).addTo(allMarkers).addTo(floodArea);
    flooding.bindPopup(
        'Flooded Area'+'</br>'
    ).openPopup(console.log("Flooded Area"));

    let fire = L.circle([44.918147, -67.875013],
        {radius: 3800,
            color:"#f40039"}).addTo(allMarkers).addTo(fireArea);
    fire.bindPopup(
        'Fire!!!'+'</br>'
    ).openPopup(console.log("Fire Area"));


    let newmarker3 = L.marker([44.808147, -68.765013]).addTo(allMarkers).addTo(users);
    newmarker3.bindPopup(
        'User: Carl'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));
    let newmarker4 = L.marker([45.918147, -68.875013]).addTo(allMarkers).addTo(users);
    newmarker4.bindPopup(
        'User: Matty O'+'</br>'+'<br/>'+
        'Status: AYYYYY HELP '+'</br>'
    ).openPopup(console.log("User"));

    //EDIT VIEW END
    let polygons = {
        'Everything': allMarkers,
        'Users': users,
        'shelters': shelters,
        'Flooded Area': floodArea,
        'Fire' :fireArea
    };
    let polygonControl = L.control.layers(polygons,null);

    let viewCount = 1;
    function viewArea() {

        if(viewCount===1){
            polygonControl.addTo(map);
            viewCount++;
        }
        else{
            map.removeControl(polygonControl);
            viewCount--;
        }

    }

</script>
</div>

<script> $('#mapPage').hide()</script>
<div class="login-page">
    <div class="form">
        <form class="register-form">
            <input id="registerName" type="text" placeholder="name"/>
            <input id="registerPasswrod" type="password" placeholder="password"/>
            <input id="registerEmail" type="text" placeholder="email address"/>

            <button>create</button>
            <p class="message">Already registered? <a href="#">Sign In</a></p>
        </form>
<!-- may need to move-->
        <form class="login-form">
            <p class="appName" >NATD App</p>
            <input id="userLogin" type="text" placeholder="username" value=""/>
            <input id="password"  type="password" placeholder="password" value=""/>
            <button type = "button" onclick="login()">login</button>
            <!--<p class="message">Not registered? <a href="#">Create an account</a></p>-->
        </form>
        <!-- IF WIFI IS DOWN OR SERVER IS DOWN user should still be allowed to draw or add information
        and store it on their phone, so the map is updated once they connect to wifi or a cell tower-->
    </div>

    <script>

        function login() {

            let userName = document.getElementById("userLogin").value;
            let user_password = document.getElementById("password").value;
            console.log(userName + "" +user_password);

            if (userName === "Cramer" && user_password === 'password') {
            alert("Welcome "+userName+"!");
           //This will dump the login and swap on the map
                //THIS WORKS FOR NOW
                //CHANGE WHEN YOU HAVE CREATED MULTIPLE
                // ACCOUNTS ITS HARD CODED

                $('.login-page').hide();
                $('#mapPage').show();

            }
            else
            {
                alert("Invalid Name or Password. " +
                    "Case sensitive!!");
            }
        }



    </script>
</div>

</body>

</html>