<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link rel="stylesheet" href="maxcdn.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css" />
    <link rel="stylesheet" href="leafletManual.css"/>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

   <!-- <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">-->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
          integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
            integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
            crossorigin=""></script>
    <link rel="stylesheet" href="mapStyle.css">
    <script type='text/javascript' src='https://cdn.scaledrone.com/scaledrone.min.js'></script>


</head>
<body style="height: 100%;">

<script src="./jquery-3.2.1.min.js"></script>
<script src="./leaflet-src.js"></script>
<script src="./leaflet.js"></script>

<script src="./leaflet-sidebar/src/L.Control.Sidebar.js"></script>
<link rel="stylesheet" href="./leaflet-sidebar/src/L.Control.Sidebar.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/esri-leaflet@2.0.8"></script>

<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.4/dist/esri-leaflet-geocoder.css">
<script src="https://unpkg.com/esri-leaflet-geocoder@2.2.4"></script>

<div id="mapPage">

<div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="#">Electric Line</a>
    <a href="#">Fallen Tree</a>
    <a href="#">Point</a>
</div>

<div id="headerImage" style="z-index: 1000; background-color: white; width: 100%;" class="headcontainer" >
    <button id = "locate" class="button button4" onclick="locate()">Locate Me</button>
    <button id="openNav" class="button button6" onclick="PopUp()">Label Area</button>

 <!--   <div class="dropup">
        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Label Area<span class="caret"></span></button>
        <ul class="dropdown-menu">
            <li><a href="#">Snow</a></li>
            <li><a href="#">Flood</a></li>
            <li><a href="#">Fire</a></li>
            <li><a href="#">Electric</a></li>
        </ul>
    </div>
-->
    <button id = "trace" class="button button7" onclick="viewArea()">Edit View</button>
    <button id="chat" class="button button8" onclick="chatRoom()">Chat</button>
</div>

<div id='map' class="leaflet-container"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.9/dist/leaflet.draw.css" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="https://cdn.rawgit.com/mejackreed/Leaflet-IIIF/v1.0.1/leaflet-iiif.js"></script>
<script src="https://unpkg.com/leaflet-draw@0.4.9/dist/leaflet.draw.js"></script>

<script>
    //Creates the basemap
    let map = L.map('map').setView([42.877742, -97.380979], 4);
    //Portland 43.6515, -70.2553
    // Additional maps

    let Satellite =  L.tileLayer(
        'http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy;<a href="http://www.esri.com/">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 18,

        });
    let Esri_WorldTopoMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom:4,
        noWrap: true,
        //maxBounds: bounds,
        maxBoundsViscosity: 1.0,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    Esri_WorldTopoMap.addTo(map);

//    let Basemaps ={
//        'Satelite':Satellite,
//        'Static Map': Esri_WorldTopoMap,
//
//    };
//    let baseMaps = L.control.layers(Basemaps,null);
//    baseMaps.addTo(map);

    // User Location Tool

    let currentPosition, currLatlngObject;
    let currentLatlng = [];

    function onLocationFound(e) {

        if (currentPosition) {
            map.removeLayer(currentPosition);
        }
//        let redMarker = L.ExtraMarkers.icon({
//            icon: 'fa-coffee',
//            markerColor: 'red',
//            shape: 'square',
//        });
//        icon: redMarker,

        currentPosition = L.marker(e.latlng,{title: "Location", draggable: false, color: "red"}).addTo(map);

        currLatlngObject = currentPosition._latlng;

        currentLatlng.push(currLatlngObject.lat);
        currentLatlng.push(currLatlngObject.lng);
        alert
        currentPosition.bindPopup("User: Cramer"
            +'<br>'+'Status: House Extremely Flooded'
            +'<br>'+'Event Type: Flooded'
            +'<br>'+'Pictures: None').openPopup(console.log("Located"));
        map.setView([currentPosition._latlng.lat,currentPosition._latlng.lng],12);
        console.log('Found');
    }

    function onLocationError(e) {
        console.log("location lost");
        console.log(e);
    }
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    function locate() {
        console.log('Finding...');
        map.locate({ maxZoom: 16});
    }

    let results = L.layerGroup().addTo(map);
    //GeoSearch plugin
    let searchControl = L.esri.Geocoding.geosearch().addTo(map);
    //Search Control
    searchControl.on('results', function(data){
        //Clears the results LayerGroup from the map
        results.clearLayers();

        for (let i = data.results.length - 1; i >= 0; i--) {
            //Displaying the searched and found location on the map
            let geoLocation = L.marker(data.results[i].latlng);

            results.addLayer(geoLocation);
        }

    });

    //Drawing Features being created

//
//
//    var fireItems = new L.FeatureGroup();
//    // Initialise the draw control and pass it the FeatureGroup of editable layers
//    var fireControl = new L.Control.Draw({
//        draw: {
//            polyline: {
//                shapeOptions: {
//                    color: '#ea1c18',
//                    weight: 10
//                }
//            },
//            polygon: {
//                allowIntersection: false,
//                drawError: {
//                    color: '#ea1c18',
//                    message: 'you can\'t draw that!'
//                },
//                shapeOptions: {
//                    color: '#ea1c18'
//                }
//            },
//            circle: false, // Turns off this drawing tool
//            rectangle: {
//                shapeOptions: {
//                    clickable: false,
//                    color:'#ea1c18'
//                }
//            },
//            edit: {
//                featureGroup: fireItems, //REQUIRED!!
//
//            }
//
//        }
//
//    });
//
//    var snowItems = new L.FeatureGroup();
//    // Initialise the draw control and pass it the FeatureGroup of editable layers
//    var snowControl = new L.Control.Draw({
//        draw: {
//            polyline: {
//                shapeOptions: {
//                    color: '#dcdcdc',
//                    weight: 10
//                }
//            },
//            polygon: {
//                allowIntersection: false,
//                drawError:{
//                    color: '#dcdcdc',
//                    message: 'no!'
//                },
//                shapeOptions: {
//                    color: '#dcdcdc'
//                }
//            },
//            circle: false,
//            rectangle: {
//                shapeOptions: {
//                    color:'#dcdcdc',
//                    clickable: true
//                }
//        },
//
//        }
//    });
//
//    var electricalItems = new L.FeatureGroup();
//    // Initialise the draw control and pass it the FeatureGroup of editable layers
//    var electricalControl = new L.Control.Draw({
//        draw: {
//            polyline: {
//                shapeOptions: {
//                    color: '#dcc511',
//                    weight: 10
//                }
//            },
//            polygon: {
//                allowIntersection: false,
//                drawError: {
//                    color: '#dcc511',
//                    message: 'NOPE!'
//                },
//                shapeOptions: {
//                    color: '#dcc511'
//                }
//            },
//            circle: false, // Turns off this drawing tool
//            rectangle: {
//                shapeOptions: {
//                    clickable: false,
//                    color: '#dcc511',
//                }
//            },
//            edit: {
//                featureGroup: electricalItems, //REQUIRED!!
//                remove: false
//            }
//
//        }
//    });
//
//
//
//    map.on(L.Draw.Event.CREATED, function (e) {
//
//        let type = e.layerType;
//        let layer = e.layer;
//        // Do whatever else you need to. (save to db, add to map etc)
//
//        floodItems.addLayer(layer);
//        fireItems.addLayer(layer);
//        snowItems.addLayer(layer);
//        electricalItems.addLayer(layer);
//
//        console.log('floodPolygon')
//    });
//
//
//    let labelCount = 1;
//    function PopUp() {
//        if (labelCount===1) {
//            // Initialise the FeatureGroup to store editable layers
//            map.addLayer(snowItems);
//            map.addControl(snowControl);
//            labelCount++;
//        }
//        else {
//            map.removeControl(snowControl);
//            map.removeControl(snowItems);
//            labelCount--;
//        }
//    }

    let floodItems = new L.FeatureGroup();
    // Initialise the draw control and pass it the FeatureGroup of editable layers
    let floodControl = new L.Control.Draw({
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#2373dc',
                    weight: 10
                }
            },
            polygon: {
                allowIntersection: false, // Restricts shapes to simple polygons
                drawError: {
                    color: '#2373dc', // Color the shape will turn when intersects
                    message: 'you can\'t draw that!' // Message that will show when intersect
                },
                shapeOptions: {
                    color: '#2373dc'
                }
            },
            circle: false, // Turns off this drawing tool
            rectangle: {
                shapeOptions: {
                    clickable: false,
                    color: "#2373dc"
                }
            }
        },

        edit: {
            featureGroup: floodItems
        }
    });

    map.on(L.Draw.Event.CREATED, function (e) {
        let type = e.layerType;
        let layer = e.layer;
        // Do whatever else you need to. (save to db, add to map etc)
        floodItems.addLayer(layer);
        console.log(e.layer);
        console.log('drawingPolygon')
    });
    let labelCount = 1;
    function PopUp() {
        if (labelCount===1) {
            // Initialise the FeatureGroup to store editable layers
            map.addLayer(floodItems);
            map.addControl(floodControl);
            labelCount++;
        }
        else {
            map.removeControl(floodControl);
            map.removeControl(floodItems);
            labelCount--;
        }
    }

//Creating markers and popup displays
    let allMarkers = L.layerGroup([]);
    let users = L.layerGroup([]);
    let shelters = L.layerGroup([]);
    let floodArea = L.layerGroup([]);
    let fireArea = L.layerGroup([]);
    let snowArea = L.layerGroup([]);
    let electricityArea = L.layerGroup([]);

    let newmarker = L.marker([44.808147, -68.795013]).addTo(allMarkers).addTo(users);
    newmarker.bindPopup(
        'User: Bob'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));
    let newmarker1 = L.marker([44.808147, -68.785013]).addTo(allMarkers).addTo(users);
    newmarker1.bindPopup(
        'User: Fred'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));

    let newmarker2 = L.circle([44.818147, -68.775013],
        {radius: 2000,
            color:"#09f40c"}).addTo(allMarkers).addTo(shelters);
    newmarker2.bindPopup(
        'Shelter'+'</br>'
    ).openPopup(console.log("Safe Area"));
    let flooding = L.circle([45.918147, -68.875013],
        {radius: 28000,
            color:"#0d00f4"}).addTo(allMarkers).addTo(floodArea);
    flooding.bindPopup(
        'Flooded Area'+'</br>'
    ).openPopup(console.log("Flooded Area"));

    let fire = L.circle([44.918147, -67.875013],
        {radius: 6800,
            color:"#f40039"}).addTo(allMarkers).addTo(fireArea);
    fire.bindPopup(
        'Fire!!!'+'</br>'
    ).openPopup(console.log("Fire Area"));
    let snow = L.circle([46.918147, -67.875013],
        {radius: 6800,
            color:"#dcdcdc"}).addTo(allMarkers).addTo(snowArea);
    snow.bindPopup(
        'Snow'+'</br>'
    ).openPopup(console.log("Snow"));


    let newmarker3 = L.marker([44.808147, -68.765013]).addTo(allMarkers).addTo(users);
    newmarker3.bindPopup(
        'User: Carl'+'</br>'+'<br/>'+
        'Status: Safe'+'</br>'
    ).openPopup(console.log("User"));
    let newmarker4 = L.marker([45.918147, -68.875013]).addTo(allMarkers).addTo(users);
    newmarker4.bindPopup(
        'User: Matty O'+'</br>'+'<br/>'+
        'Status: AYYYYY HELP '+'</br>'
    ).openPopup(console.log("User"));

    //EDIT VIEW END
    let polygons = {
        'Everything': allMarkers,
        'Users': users,
        'shelters': shelters,
        'Flooding': floodArea,
        'Fire' :fireArea,
        'Snow' :snowArea,
        'Electricity' :electricityArea,
    };
    let polygonControl = L.control.layers(polygons,null);

    let viewCount = 1;
    function viewArea() {

        if(viewCount===1){
            polygonControl.addTo(map);
            viewCount++;
        }
        else{
            map.removeControl(polygonControl);
            viewCount--;
        }

    }

</script>
</div>
<div id="chatRoom_html" style="overflow: scroll">

    <div class="members-count"></div>
    <div class="members-list"></div>
    <div class="messages"></div>
    <form class="message-form" onsubmit="return false;">
        <input class="message-form__input" placeholder="Type a message.." type="text"/>
        <input class="message-form__button" value="Send" type="submit"/>
    </form>
</div>
<script src="chatChannel.js">
</script>
<script> $('#mapPage').hide();
         $('#chatRoom_html').hide();
let chatCount = 1;
function chatRoom(){

    if(chatCount===1){
        $('#chatRoom_html').show();
        console.log('Chat displayed');
        chatCount++;
    }
    else{
        $('#chatRoom_html').hide();
        console.log('Chat hidden');
        chatCount--;
    }

}</script>
<div class="login-page">
    <div class="form">
        <form class="register-form">
            <input id="registerName" type="text" placeholder="name"/>
            <input id="registerPasswrod" type="password" placeholder="password"/>
            <input id="registerEmail" type="text" placeholder="email address"/>

            <button>create</button>
            <p class="message">Already registered? <a href="#">Sign In</a></p>
        </form>
<!-- may need to move-->
        <form class="login-form">
            <p class="appName" >NATD App</p>
            <input id="userLogin" type="text" placeholder="username" value=""/>
            <input id="password"  type="password" placeholder="password" value=""/>
            <button type = "button" onclick="login()">login</button>
            <!--<p class="message">Not registered? <a href="#">Create an account</a></p>-->
        </form>
        <!-- IF WIFI IS DOWN OR SERVER IS DOWN user should still be allowed to draw or add information
        and store it on their phone, so the map is updated once they connect to wifi or a cell tower-->
    </div>

    <script>

        function login() {

            let userName = document.getElementById("userLogin").value;
            let user_password = document.getElementById("password").value;
            console.log(userName + "" +user_password);

            if (userName === "Cramer" && user_password === 'password') {
            alert("Welcome "+userName+"!");
           //This will dump the login and swap on the map
                //THIS WORKS FOR NOW
                //CHANGE WHEN YOU HAVE CREATED MULTIPLE
                // ACCOUNTS ITS HARD CODED

                $('.login-page').hide();
                $('#mapPage').show();

            }
            else
            {
                alert("Invalid Name or Password. " +
                    "Case sensitive!!");
            }
        }



    </script>
</div>


</body>

</html>